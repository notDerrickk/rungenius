<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>RunGenius - √âditeur de Programme</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="alternate icon" href="/favicon.ico">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: linear-gradient(135deg,#e6f0ff 0%, #f7f9fb 100%); min-height: 100vh; padding: 20px 0; }
        .card { border: none; border-radius: 15px; overflow: hidden; }
        .header { background: linear-gradient(135deg,#2b8aef,#764ba2); color: white; padding: 30px; text-align: center; }
        .seance-card { border: 1px solid #dee2e6; border-radius: 10px; padding: 15px; margin-bottom: 15px; background: white; }
        .week-header { background: linear-gradient(135deg,#667eea,#764ba2); color: white; padding: 15px; border-radius: 10px; margin-bottom: 15px; }
        .btn-add-seance { border-style: dashed; }
        .seance-type-badge { font-size: 0.85em; }
        .allure-custom { background-color: #fff3cd; border-color: #ffc107; }
    </style>
</head>
<body>

<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card shadow-lg">
                <div class="header">
                    <h1>üèÉ RunGenius - √âditeur</h1>
                    <p class="mb-0">Cr√©ez votre programme d'entra√Ænement personnalis√©</p>
                </div>
                <div class="card-body p-4">
                    
                    <!-- Configuration du programme -->
                    <div class="mb-4" id="configSection">
                        <h4 class="mb-3">Configuration du programme</h4>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Titre du programme</label>
                                <input type="text" id="programTitle" class="form-control" value="Mon Programme Personnalis√©">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Distance (km)</label>
                                <input type="number" id="programDistance" class="form-control" value="10" step="0.1">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">VMA (km/h)</label>
                                <input type="number" id="programVma" class="form-control" value="15.0" step="0.1">
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Nombre de semaines</label>
                                <input type="number" id="nbWeeks" class="form-control" value="8" min="4" max="52">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Sorties / semaine</label>
                                <input type="number" id="nbSessions" class="form-control" value="3" min="1" max="7">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Objectif temps (MM:SS ou HH:MM:SS)</label>
                                <input type="text" id="objectifTemps" class="form-control" value="50:00">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Date de la course</label>
                                <input type="date" id="raceDate" class="form-control">
                            </div>
                        </div>

                        <hr>
                        <h5 class="mb-3">Configuration des allures</h5>
                        <div class="alert alert-info">
                            <small>Cliquez sur "Calculer les allures automatiquement" pour g√©n√©rer les allures selon votre VMA et objectif, puis modifiez-les si n√©cessaire.</small>
                        </div>

                        <div class="row mb-3">
                            <div class="col-12">
                                <button class="btn btn-secondary" onclick="calculerAlluresAuto()">
                                    üî¢ Calculer les allures automatiquement
                                </button>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Allure EF (min/km)</label>
                                <input type="text" id="allureEF" class="form-control" value="6:00">
                                <small class="text-muted">65% VMA</small>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Allure Seuil (min/km)</label>
                                <input type="text" id="allureSeuil" class="form-control" value="4:42">
                                <small class="text-muted">85% VMA</small>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Allure VMA (min/km)</label>
                                <input type="text" id="allureVMA" class="form-control" value="4:00">
                                <small class="text-muted">100% VMA</small>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Allure Objectif (min/km)</label>
                                <input type="text" id="allureObjectif" class="form-control" value="5:00">
                                <small class="text-muted">Bas√©e sur objectif temps</small>
                            </div>
                        </div>

                        <button class="btn btn-primary btn-lg" onclick="initializeProgram()">
                            Initialiser le programme
                        </button>
                    </div>

                    <hr>

                    <!-- Zone d'√©dition des s√©ances -->
                    <div id="programEditor" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h4 class="mb-0">√âdition des s√©ances</h4>
                            <div>
                                <button class="btn btn-secondary me-2" onclick="recalculerAllures()">
                                    üîÅ Recalculer les allures
                                </button>
                                <button class="btn btn-success me-2" onclick="generateHTML()">
                                    üìÑ G√©n√©rer le programme HTML
                                </button>
                                <button class="btn btn-primary" onclick="downloadHTML()">
                                    üíæ T√©l√©charger
                                </button>
                            </div>
                        </div>

                        <div id="weeksContainer">
                            <!-- Les semaines seront ajout√©es dynamiquement ici -->
                        </div>
                    </div>

                    <div th:if="${error}" class="alert alert-danger mt-3">
                        <span th:text="${error}"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let programData = {
    title: '',
    distance: 10,
    vma: 15.0,
    nbWeeks: 8,
    nbSessions: 3,
    objectifTemps: '',
    allures: {},
    raceDate: '',
    weeks: [],
    _allurePct: {} // Stocke les pourcentages VMA calcul√©s
};

// Formater une allure en minutes d√©cimales vers "MM:SS"
function formatAllure(minutesPerKm) {
    const minutes = Math.floor(minutesPerKm);
    const seconds = Math.round((minutesPerKm - minutes) * 60);
    return `${minutes}:${seconds.toString().padStart(2, '0')}`;
}

// Parser une allure "MM:SS" vers minutes d√©cimales
function parseAllure(allureStr) {
    if (!allureStr) return null;
    const parts = allureStr.trim().split(':');
    if (parts.length === 2) {
        const minutes = parseInt(parts[0]);
        const seconds = parseInt(parts[1]);
        return minutes + seconds / 60.0;
    }
    return null;
}

// Parser un temps objectif "MM:SS" ou "HH:MM:SS" vers secondes totales
function parseTimeToSeconds(timeStr) {
    if (!timeStr) return null;
    const parts = timeStr.trim().split(':');
    try {
        if (parts.length === 1) {
            return parseInt(parts[0]) * 60; // Minutes seulement
        } else if (parts.length === 2) {
            return parseInt(parts[0]) * 60 + parseInt(parts[1]); // MM:SS
        } else if (parts.length === 3) {
            return parseInt(parts[0]) * 3600 + parseInt(parts[1]) * 60 + parseInt(parts[2]); // HH:MM:SS
        }
    } catch (e) {
        return null;
    }
    return null;
}

// Calculer l'allure objectif depuis le temps objectif et la distance
function getAllureFromObjectif(distanceKm, objectifSeconds) {
    if (!objectifSeconds || objectifSeconds <= 0 || distanceKm <= 0) {
        return null;
    }
    const secondsPerKm = objectifSeconds / distanceKm;
    const minutesPerKm = secondsPerKm / 60.0;
    return minutesPerKm;
}

// Calculer le pourcentage VMA depuis une allure en min/km
function getPourcentageFromAllure(vma, minutesPerKm) {
    if (minutesPerKm <= 0 || vma <= 0) return 0.65;
    return 60.0 / (vma * minutesPerKm);
}

// Calculer automatiquement les allures selon la VMA et l'objectif (comme ConfigProgrammeDialog.calculerAllures())
function calculerAlluresAuto() {
    const vma = parseFloat(document.getElementById('programVma').value);
    const distanceKm = parseFloat(document.getElementById('programDistance').value);
    const objectifStr = document.getElementById('objectifTemps').value;
    
    if (!vma || vma <= 0) {
        alert('Veuillez entrer une VMA valide.');
        return;
    }

    // Calculer les allures bas√©es sur la VMA
    const allureEFValue = 60.0 / (vma * 0.65); // 65% VMA
    const allureSeuilValue = 60.0 / (vma * 0.85); // 85% VMA
    const allureVMAValue = 60.0 / vma; // 100% VMA

    document.getElementById('allureEF').value = formatAllure(allureEFValue);
    document.getElementById('allureSeuil').value = formatAllure(allureSeuilValue);
    document.getElementById('allureVMA').value = formatAllure(allureVMAValue);

    // Calculer l'allure objectif si un objectif temps est fourni
    const objectifSeconds = parseTimeToSeconds(objectifStr);
    if (objectifSeconds && distanceKm > 0) {
        const allureObjectifValue = getAllureFromObjectif(distanceKm, objectifSeconds);
        if (allureObjectifValue) {
            document.getElementById('allureObjectif').value = formatAllure(allureObjectifValue);
        }
    }

    alert('Allures calcul√©es automatiquement selon votre VMA et objectif.');
}

function initializeProgram() {
    programData.title = document.getElementById('programTitle').value;
    programData.distance = parseFloat(document.getElementById('programDistance').value);
    programData.vma = parseFloat(document.getElementById('programVma').value);
    programData.nbWeeks = parseInt(document.getElementById('nbWeeks').value);
    programData.nbSessions = parseInt(document.getElementById('nbSessions').value);
    programData.objectifTemps = document.getElementById('objectifTemps').value;
    programData.raceDate = document.getElementById('raceDate').value;
    
    programData.allures = {
        ef: document.getElementById('allureEF').value,
        seuil: document.getElementById('allureSeuil').value,
        vma: document.getElementById('allureVMA').value,
        objectif: document.getElementById('allureObjectif').value
    };

    // Calculer les pourcentages VMA pour chaque allure
    programData._allurePct = {
        ef: getPourcentageFromAllure(programData.vma, parseAllure(programData.allures.ef)),
        seuil: getPourcentageFromAllure(programData.vma, parseAllure(programData.allures.seuil)),
        vma: getPourcentageFromAllure(programData.vma, parseAllure(programData.allures.vma)),
        objectif: getPourcentageFromAllure(programData.vma, parseAllure(programData.allures.objectif))
    };

    // Initialiser les semaines
    programData.weeks = [];
    for (let i = 0; i < programData.nbWeeks; i++) {
        let week = [];
        for (let j = 0; j < programData.nbSessions; j++) {
            week.push({
                nom: `Semaine ${i+1} - S√©ance ${j+1}`,
                type: 'Endurance',
                echauffement: 15,
                corps: '40 min en endurance fondamentale',
                allure: 'ef',
                allureText: programData.allures.ef,
                allurePct: programData._allurePct.ef,
                cooldown: 10,
                customAllure: false
            });
        }
        programData.weeks.push(week);
    }

    document.getElementById('configSection').style.display = 'none';
    document.getElementById('programEditor').style.display = 'block';
    renderProgram();
}

// Recalculer les allures pour toutes les s√©ances non-personnalis√©es
function recalculerAllures() {
    programData._allurePct = {
        ef: getPourcentageFromAllure(programData.vma, parseAllure(programData.allures.ef)),
        seuil: getPourcentageFromAllure(programData.vma, parseAllure(programData.allures.seuil)),
        vma: getPourcentageFromAllure(programData.vma, parseAllure(programData.allures.vma)),
        objectif: getPourcentageFromAllure(programData.vma, parseAllure(programData.allures.objectif))
    };

    // Mettre √† jour les s√©ances qui ne sont pas personnalis√©es
    let nbUpdated = 0;
    for (let i = 0; i < programData.weeks.length; i++) {
        for (let j = 0; j < programData.weeks[i].length; j++) {
            const seance = programData.weeks[i][j];
            if (!seance.customAllure) {
                const key = seance.allure || 'ef';
                seance.allureText = programData.allures[key];
                seance.allurePct = programData._allurePct[key];
                nbUpdated++;
            }
        }
    }
    
    alert(`${nbUpdated} s√©ance(s) recalcul√©e(s).`);
    renderProgram();
}

function renderProgram() {
    const container = document.getElementById('weeksContainer');
    container.innerHTML = '';

    for (let i = 0; i < programData.weeks.length; i++) {
        const weekDiv = document.createElement('div');
        weekDiv.className = 'mb-4';
        
        const weekHeader = document.createElement('div');
        weekHeader.className = 'week-header';
        weekHeader.innerHTML = `<h5 class="mb-0">üìÖ Semaine ${i+1}</h5>`;
        weekDiv.appendChild(weekHeader);

        for (let j = 0; j < programData.weeks[i].length; j++) {
            const seance = programData.weeks[i][j];
            const seanceCard = createSeanceCard(i, j, seance);
            weekDiv.appendChild(seanceCard);
        }

        // Bouton ajouter s√©ance
        const addBtn = document.createElement('button');
        addBtn.className = 'btn btn-outline-primary btn-add-seance w-100';
        addBtn.innerHTML = '‚ûï Ajouter une s√©ance';
        addBtn.onclick = () => addSeance(i);
        weekDiv.appendChild(addBtn);

        container.appendChild(weekDiv);
    }
}

function createSeanceCard(weekIdx, seanceIdx, seance) {
    const card = document.createElement('div');
    card.className = 'seance-card';
    
    const customClass = seance.customAllure ? 'allure-custom' : '';
    const customChecked = seance.customAllure ? 'checked' : '';

    card.innerHTML = `
        <div class="d-flex justify-content-between align-items-start mb-2">
            <div>
                <strong>${seance.nom}</strong>
                <span class="badge bg-info seance-type-badge ms-2">${seance.type}</span>
                ${seance.customAllure ? '<span class="badge bg-warning seance-type-badge ms-1">Personnalis√©</span>' : ''}
            </div>
            <button class="btn btn-sm btn-danger" onclick="deleteSeance(${weekIdx}, ${seanceIdx})">üóëÔ∏è</button>
        </div>
        <div class="row">
            <div class="col-md-6 mb-2">
                <label class="form-label small">Nom</label>
                <input type="text" class="form-control form-control-sm" value="${seance.nom}" 
                    onchange="updateSeance(${weekIdx}, ${seanceIdx}, 'nom', this.value)">
            </div>
            <div class="col-md-6 mb-2">
                <label class="form-label small">Type</label>
                <select class="form-select form-select-sm" 
                    onchange="updateSeance(${weekIdx}, ${seanceIdx}, 'type', this.value)">
                    <option value="Endurance" ${seance.type === 'Endurance' ? 'selected' : ''}>Endurance</option>
                    <option value="Fractionn√©" ${seance.type === 'Fractionn√©' ? 'selected' : ''}>Fractionn√©</option>
                    <option value="Sortie longue" ${seance.type === 'Sortie longue' ? 'selected' : ''}>Sortie longue</option>
                    <option value="Seuil" ${seance.type === 'Seuil' ? 'selected' : ''}>Seuil</option>
                    <option value="VMA" ${seance.type === 'VMA' ? 'selected' : ''}>VMA</option>
                    <option value="R√©cup√©ration" ${seance.type === 'R√©cup√©ration' ? 'selected' : ''}>R√©cup√©ration</option>
                </select>
            </div>
        </div>
        <div class="row">
            <div class="col-md-3 mb-2">
                <label class="form-label small">√âchauffement (min)</label>
                <input type="number" class="form-control form-control-sm" value="${seance.echauffement}" 
                    onchange="updateSeance(${weekIdx}, ${seanceIdx}, 'echauffement', parseInt(this.value))">
            </div>
            <div class="col-md-3 mb-2">
                <label class="form-label small">Cooldown (min)</label>
                <input type="number" class="form-control form-control-sm" value="${seance.cooldown}" 
                    onchange="updateSeance(${weekIdx}, ${seanceIdx}, 'cooldown', parseInt(this.value))">
            </div>
            <div class="col-md-6 mb-2">
                <label class="form-label small">Allure (type)</label>
                <select class="form-select form-select-sm" 
                    onchange="updateSeance(${weekIdx}, ${seanceIdx}, 'allure', this.value)">
                    <option value="ef" ${seance.allure === 'ef' ? 'selected' : ''}>Endurance Fondamentale (${programData.allures.ef})</option>
                    <option value="seuil" ${seance.allure === 'seuil' ? 'selected' : ''}>Allure Seuil (${programData.allures.seuil})</option>
                    <option value="vma" ${seance.allure === 'vma' ? 'selected' : ''}>Allure VMA (${programData.allures.vma})</option>
                    <option value="objectif" ${seance.allure === 'objectif' ? 'selected' : ''}>Allure Objectif (${programData.allures.objectif})</option>
                </select>
            </div>
        </div>
        <div class="row align-items-center mb-2">
            <div class="col-md-9">
                <label class="form-label small">Allure (min/km) - modifiable</label>
                <input type="text" class="form-control form-control-sm ${customClass}" 
                    value="${seance.allureText || programData.allures[seance.allure || 'ef']}" 
                    onchange="updateSeanceAllureText(${weekIdx}, ${seanceIdx}, this.value)">
            </div>
            <div class="col-md-3">
                <div class="form-check mt-4">
                    <input class="form-check-input" type="checkbox" id="custom_${weekIdx}_${seanceIdx}" 
                        ${customChecked} onchange="toggleCustomAllure(${weekIdx}, ${seanceIdx}, this.checked)">
                    <label class="form-check-label small" for="custom_${weekIdx}_${seanceIdx}">
                        Personnalis√©
                    </label>
                </div>
            </div>
        </div>
        <div class="mb-2">
            <label class="form-label small">Corps de s√©ance</label>
            <textarea class="form-control form-control-sm" rows="2" 
                onchange="updateSeance(${weekIdx}, ${seanceIdx}, 'corps', this.value)">${seance.corps}</textarea>
        </div>
    `;
    
    return card;
}

function updateSeance(weekIdx, seanceIdx, field, value) {
    programData.weeks[weekIdx][seanceIdx][field] = value;
    if (field === 'nom' || field === 'type') {
        renderProgram();
    } else if (field === 'allure') {
        const seance = programData.weeks[weekIdx][seanceIdx];
        if (!seance.customAllure) {
            seance.allureText = programData.allures[value];
            seance.allurePct = programData._allurePct[value];
        }
        renderProgram();
    }
}

function updateSeanceAllureText(weekIdx, seanceIdx, newText) {
    const seance = programData.weeks[weekIdx][seanceIdx];
    seance.allureText = newText;
    seance.customAllure = true;
    seance.allurePct = getPourcentageFromAllure(programData.vma, parseAllure(newText));
    renderProgram();
}

function toggleCustomAllure(weekIdx, seanceIdx, isCustom) {
    const seance = programData.weeks[weekIdx][seanceIdx];
    seance.customAllure = isCustom;
    
    if (!isCustom) {
        const key = seance.allure || 'ef';
        seance.allureText = programData.allures[key];
        seance.allurePct = programData._allurePct[key];
    } else {
        seance.allurePct = getPourcentageFromAllure(programData.vma, parseAllure(seance.allureText));
    }
    
    renderProgram();
}

function deleteSeance(weekIdx, seanceIdx) {
    if (confirm('Supprimer cette s√©ance ?')) {
        programData.weeks[weekIdx].splice(seanceIdx, 1);
        renderProgram();
    }
}

function addSeance(weekIdx) {
    programData.weeks[weekIdx].push({
        nom: `Semaine ${weekIdx+1} - S√©ance ${programData.weeks[weekIdx].length + 1}`,
        type: 'Endurance',
        echauffement: 15,
        corps: '40 min en endurance fondamentale',
        allure: 'ef',
        allureText: programData.allures.ef,
        allurePct: programData._allurePct.ef,
        cooldown: 10,
        customAllure: false
    });
    renderProgram();
}

function generateHTML() {
    fetch('/editor/generate', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(programData)
    })
    .then(response => response.text())
    .then(html => {
        document.open();
        document.write(html);
        document.close();
    })
    .catch(error => {
        alert('Erreur lors de la g√©n√©ration: ' + error);
    });
}

function downloadHTML() {
    fetch('/editor/download', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(programData)
    })
    .then(response => response.blob())
    .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'programme_' + programData.title.replace(/\s+/g, '_') + '.html';
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
    })
    .catch(error => {
        alert('Erreur lors du t√©l√©chargement: ' + error);
    });
}

// Initialiser la date par d√©faut
document.getElementById('raceDate').value = new Date(Date.now() + 90*24*60*60*1000).toISOString().split('T')[0];
</script>

</body>
</html>