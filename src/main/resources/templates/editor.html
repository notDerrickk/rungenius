<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="fr">
<head>
    <title>RunGenius — Éditeur</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="alternate icon" href="/favicon.ico">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/app.css}">
</head>

<body>
<div class="rg-topbar">
    <div class="container py-3">
        <div class="d-flex align-items-center justify-content-between gap-2">
            <a class="rg-brand" href="/">
                <img src="/logo.png" alt="RunGenius" class="rg-logo">
            </a>
            <div class="d-flex align-items-center gap-2">
                <button class="rg-btn d-none d-sm-inline-flex" type="button" data-theme-toggle aria-pressed="false">Clair</button>
                <button class="rg-btn d-inline-flex d-sm-none" type="button" data-theme-toggle aria-pressed="false">Clair</button>
                <a class="rg-btn" href="/">Générateur</a>
            </div>
        </div>
    </div>
</div>

<div class="container my-4" style="padding-bottom: 90px;">
    <div class="rg-card mb-3" id="configSection">
        <div class="rg-card-inner">
            <div class="d-flex justify-content-between align-items-start gap-2">
                <div>
                    <div class="rg-section-title">Editeur de programme</div>
                    <div class="small-muted mt-1">Paramètres du programme + calcul des allures.</div>
                </div>
            </div>

            <div class="rg-divider"></div>

            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label">Titre du programme</label>
                    <input type="text" id="programTitle" class="form-control rg-input" value="Mon Programme Personnalisé">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Distance (km)</label>
                    <input type="number" id="programDistance" class="form-control rg-input" value="10" step="0.1">
                </div>
                <div class="col-md-3">
                    <label class="form-label">VMA (km/h)</label>
                    <input type="number" id="programVma" class="form-control rg-input" value="15.0" step="0.1">
                </div>

                <div class="col-md-3">
                    <label class="form-label">Nombre de semaines</label>
                    <input type="number" id="nbWeeks" class="form-control rg-input" value="8" min="4" max="52">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Sorties / semaine</label>
                    <input type="number" id="nbSessions" class="form-control rg-input" value="3" min="1" max="7">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Objectif temps</label>
                    <input type="text" id="objectifTemps" class="form-control rg-input" value="50:00">
                    <div class="small-muted">MM:SS ou HH:MM:SS</div>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Date de la course</label>
                    <input type="date" id="raceDate" class="form-control rg-input">
                </div>
            </div>

            <div class="rg-divider"></div>

            <div id="beforeInitActions">
                <div class="d-flex flex-wrap gap-2 align-items-center justify-content-between">
                    <div class="small-muted">
                        Étape 1: Calculez d'abord les allures selon votre VMA et objectif
                    </div>
                    <button class="rg-btn" type="button" onclick="calculerAlluresAuto()">Calculer les allures</button>
                </div>
                <div class="rg-divider"></div>
                <div class="d-flex flex-wrap gap-2 align-items-center justify-content-between">
                    <div>
                        <div class="small-muted mb-1">Étape 2: Initialisez votre programme personnalisé</div>
                        <div class="small-muted">Crée la structure du programme avec vos paramètres (semaines, séances/semaine) que vous pourrez ensuite modifier.</div>
                    </div>
                    <button class="rg-btn rg-btn-primary" type="button" onclick="initializeProgram()">Initialiser le programme</button>
                </div>
            </div>
            <div id="afterInitActions" style="display:none;">
                <div class="d-flex flex-wrap gap-2 align-items-center justify-content-end">
                    <button class="rg-btn" type="button" onclick="recalculerAllures()">Recalculer les allures</button>
                </div>
            </div>
        </div>
    </div>

    <div class="rg-card mb-3" id="paceCards">
        <div class="rg-card-inner">
            <div class="d-flex justify-content-between align-items-center gap-2">
                <div>
                    <div class="rg-section-title">Zones d'allure</div>
                </div>
            </div>

            <div class="rg-divider"></div>


            <div class="row g-3 mt-2">
                <div class="col-sm-6 col-md-3">
                    <label class="form-label">Allure EF (min/km)</label>
                    <input type="text" id="allureEF" class="form-control rg-input" value="6:00">
                </div>
                <div class="col-sm-6 col-md-3">
                    <label class="form-label">Allure Objectif (min/km)</label>
                    <input type="text" id="allureObjectif" class="form-control rg-input" value="5:00">
                </div>
                <div class="col-sm-6 col-md-3">
                    <label class="form-label">Allure Seuil (min/km)</label>
                    <input type="text" id="allureSeuil" class="form-control rg-input" value="4:42">
                </div>
                <div class="col-sm-6 col-md-3">
                    <label class="form-label">Allure VMA (min/km)</label>
                    <input type="text" id="allureVMA" class="form-control rg-input" value="4:00">
                </div>
            </div>
        </div>
    </div>

    <!-- Program editor -->
    <div class="rg-card" id="programEditor" style="display:none;">
        <div class="rg-card-inner">
            <div class="d-flex justify-content-between align-items-center gap-2">
                <div>
                    <div class="rg-section-title">Édition des séances</div>
                    <div class="small-muted mt-1">Simple, lisible, exportable via ton backend.</div>
                </div>
            </div>

            <div class="rg-divider"></div>

            <div id="weeksContainer"></div>

            <div class="rg-divider"></div>

            <div class="d-flex justify-content-stretch justify-content-md-end">
                <button class="rg-btn rg-btn-primary btn-lg w-100 w-md-auto" type="button" onclick="generateHTMLInSameWindow()">
                    Générer le programme
                </button>
            </div>
        </div>
    </div>

    <div th:if="${error}" class="alert alert-danger mt-3">
        <span th:text="${error}"></span>
    </div>
</div>

<div class="rg-actionbar" id="actionBar" style="display:none;">
    <div class="container">
        <div class="wrap" style="justify-content: center;">
            <button class="rg-btn rg-btn-primary w-100 w-sm-auto" type="button" onclick="generateHTMLInSameWindow()" style="max-width: 400px;">Générer le programme</button>
        </div>
    </div>
</div>

<script th:src="@{/app.js}"></script>

<script>
let programData = {
    title: '',
    distance: 10,
    vma: 15.0,
    nbWeeks: 8,
    nbSessions: 3,
    objectifTemps: '',
    allures: {},
    raceDate: '',
    weeks: [],
    _allurePct: {}
};

function formatAllure(minutesPerKm) {
    const minutes = Math.floor(minutesPerKm);
    const seconds = Math.round((minutesPerKm - minutes) * 60);
    return `${minutes}:${seconds.toString().padStart(2, '0')}`;
}
function parseAllure(allureStr) {
    if (!allureStr) return null;
    const parts = allureStr.trim().split(':');
    if (parts.length === 2) {
        const minutes = parseInt(parts[0]);
        const seconds = parseInt(parts[1]);
        return minutes + seconds / 60.0;
    }
    return null;
}
function parseTimeToSeconds(timeStr) {
    if (!timeStr) return null;
    const parts = timeStr.trim().split(':');
    try {
        if (parts.length === 1) return parseInt(parts[0]) * 60;
        if (parts.length === 2) return parseInt(parts[0]) * 60 + parseInt(parts[1]);
        if (parts.length === 3) return parseInt(parts[0]) * 3600 + parseInt(parts[1]) * 60 + parseInt(parts[2]);
    } catch (e) { return null; }
    return null;
}
function getAllureFromObjectif(distanceKm, objectifSeconds) {
    if (!objectifSeconds || objectifSeconds <= 0 || distanceKm <= 0) return null;
    const secondsPerKm = objectifSeconds / distanceKm;
    return secondsPerKm / 60.0;
}
function getPourcentageFromAllure(vma, minutesPerKm) {
    if (minutesPerKm <= 0 || vma <= 0) return 0.65;
    return 60.0 / (vma * minutesPerKm);
}

function updatePaceCards(){
    document.getElementById('paceEFCard').textContent = document.getElementById('allureEF').value || '—';
    document.getElementById('paceObjCard').textContent = document.getElementById('allureObjectif').value || '—';
    document.getElementById('paceSeuilCard').textContent = document.getElementById('allureSeuil').value || '—';
    document.getElementById('paceVMACard').textContent = document.getElementById('allureVMA').value || '—';
}

function calculerAlluresAuto() {
    const vma = parseFloat(document.getElementById('programVma').value);
    const distanceKm = parseFloat(document.getElementById('programDistance').value);
    const objectifStr = document.getElementById('objectifTemps').value;

    if (!vma || vma <= 0) { alert('Veuillez entrer une VMA valide.'); return; }

    document.getElementById('allureEF').value = formatAllure(60.0 / (vma * 0.65));
    document.getElementById('allureSeuil').value = formatAllure(60.0 / (vma * 0.85));
    document.getElementById('allureVMA').value = formatAllure(60.0 / vma);

    const objectifSeconds = parseTimeToSeconds(objectifStr);
    if (objectifSeconds && distanceKm > 0) {
        const allureObjectifValue = getAllureFromObjectif(distanceKm, objectifSeconds);
        if (allureObjectifValue) document.getElementById('allureObjectif').value = formatAllure(allureObjectifValue);
    }

    updatePaceCards();
    alert('Allures calculées.');
}

function initializeProgram() {
    programData.title = document.getElementById('programTitle').value;
    programData.distance = parseFloat(document.getElementById('programDistance').value);
    programData.vma = parseFloat(document.getElementById('programVma').value);
    programData.nbWeeks = parseInt(document.getElementById('nbWeeks').value);
    programData.nbSessions = parseInt(document.getElementById('nbSessions').value);
    programData.objectifTemps = document.getElementById('objectifTemps').value;
    programData.raceDate = document.getElementById('raceDate').value;

    programData.allures = {
        ef: document.getElementById('allureEF').value,
        seuil: document.getElementById('allureSeuil').value,
        vma: document.getElementById('allureVMA').value,
        objectif: document.getElementById('allureObjectif').value
    };

    programData._allurePct = {
        ef: getPourcentageFromAllure(programData.vma, parseAllure(programData.allures.ef)),
        seuil: getPourcentageFromAllure(programData.vma, parseAllure(programData.allures.seuil)),
        vma: getPourcentageFromAllure(programData.vma, parseAllure(programData.allures.vma)),
        objectif: getPourcentageFromAllure(programData.vma, parseAllure(programData.allures.objectif))
    };

    programData.weeks = [];
    for (let i = 0; i < programData.nbWeeks; i++) {
        let week = [];
        for (let j = 0; j < programData.nbSessions; j++) {
            week.push({
                nom: `Semaine ${i+1} - Séance ${j+1}`,
                type: 'Endurance',
                echauffement: 15,
                corps: '40 min en endurance fondamentale',
                allure: 'ef',
                allureText: programData.allures.ef,
                allurePct: programData._allurePct.ef,
                cooldown: 10,
                customAllure: false
            });
        }
        programData.weeks.push(week);
    }

    document.getElementById('beforeInitActions').style.display = 'none';
    document.getElementById('afterInitActions').style.display = 'block';
    document.getElementById('programEditor').style.display = 'block';
    document.getElementById('actionBar').style.display = 'block';
    renderProgram();
}

function recalculerAllures() {
    programData._allurePct = {
        ef: getPourcentageFromAllure(programData.vma, parseAllure(programData.allures.ef)),
        seuil: getPourcentageFromAllure(programData.vma, parseAllure(programData.allures.seuil)),
        vma: getPourcentageFromAllure(programData.vma, parseAllure(programData.allures.vma)),
        objectif: getPourcentageFromAllure(programData.vma, parseAllure(programData.allures.objectif))
    };

    let nbUpdated = 0;
    for (let i = 0; i < programData.weeks.length; i++) {
        for (let j = 0; j < programData.weeks[i].length; j++) {
            const seance = programData.weeks[i][j];
            if (!seance.customAllure) {
                const key = seance.allure || 'ef';
                seance.allureText = programData.allures[key];
                seance.allurePct = programData._allurePct[key];
                nbUpdated++;
            }
        }
    }
    updatePaceCards();
    alert(`${nbUpdated} séance(s) recalculée(s).`);
    renderProgram();
}

function renderProgram() {
    const container = document.getElementById('weeksContainer');
    container.innerHTML = '';

    for (let i = 0; i < programData.weeks.length; i++) {
        const weekEl = document.createElement('div');
        weekEl.className = 'rg-week';

        weekEl.innerHTML = `
          <div class="rg-week-head">
            <h3 class="rg-week-title">Semaine ${i+1}</h3>
            <button class="rg-btn" type="button" onclick="addSeance(${i})">+ Séance</button>
          </div>
          <div class="rg-week-body" id="week_${i}"></div>
        `;
        container.appendChild(weekEl);

        const weekBody = document.getElementById(`week_${i}`);
        for (let j = 0; j < programData.weeks[i].length; j++) {
            const s = programData.weeks[i][j];
            const card = document.createElement('div');
            card.className = 'rg-session';

            card.innerHTML = `
              <div class="d-flex justify-content-between align-items-start gap-2">
                <div>
                  <p class="rg-session-title">${escapeHtml(s.nom)}</p>
                  <div class="rg-session-sub">${escapeHtml(s.type)} • ${escapeHtml(s.allureText || '')}</div>
                </div>
                <button class="rg-btn" type="button" onclick="deleteSeance(${i}, ${j})">Supprimer</button>
              </div>

              <div class="row g-3 mt-2">
                <div class="col-md-6">
                  <label class="form-label">Nom</label>
                  <input class="form-control rg-input" value="${escapeAttr(s.nom)}"
                    onchange="updateSeance(${i},${j},'nom',this.value)">
                </div>
                <div class="col-md-6">
                  <label class="form-label">Type</label>
                  <select class="form-select rg-select"
                    onchange="updateSeance(${i},${j},'type',this.value)">
                    ${['Endurance','Fractionné','Sortie longue','Seuil','VMA','Récupération']
                      .map(t=>`<option value="${t}" ${s.type===t?'selected':''}>${t}</option>`).join('')}
                  </select>
                </div>

                <div class="col-md-3">
                  <label class="form-label">Échauffement (min)</label>
                  <input type="number" class="form-control rg-input" value="${Number(s.echauffement||0)}"
                    onchange="updateSeance(${i},${j},'echauffement',parseInt(this.value||0))">
                </div>
                <div class="col-md-3">
                  <label class="form-label">Cooldown (min)</label>
                  <input type="number" class="form-control rg-input" value="${Number(s.cooldown||0)}"
                    onchange="updateSeance(${i},${j},'cooldown',parseInt(this.value||0))">
                </div>

                <div class="col-md-6">
                  <label class="form-label">Allure (zone)</label>
                  <select class="form-select rg-select"
                    onchange="updateSeance(${i},${j},'allure',this.value)">
                    <option value="ef" ${s.allure==='ef'?'selected':''}>EF (${escapeHtml(programData.allures.ef||'')})</option>
                    <option value="objectif" ${s.allure==='objectif'?'selected':''}>Objectif (${escapeHtml(programData.allures.objectif||'')})</option>
                    <option value="seuil" ${s.allure==='seuil'?'selected':''}>Seuil (${escapeHtml(programData.allures.seuil||'')})</option>
                    <option value="vma" ${s.allure==='vma'?'selected':''}>VMA (${escapeHtml(programData.allures.vma||'')})</option>
                  </select>
                </div>

                <div class="col-12">
                  <label class="form-label">Corps</label>
                  <textarea class="form-control rg-textarea" rows="2"
                    onchange="updateSeance(${i},${j},'corps',this.value)">${escapeHtml(s.corps||'')}</textarea>
                </div>
              </div>
            `;
            weekBody.appendChild(card);
        }
    }
}

function updateSeance(weekIdx, seanceIdx, field, value) {
    programData.weeks[weekIdx][seanceIdx][field] = value;
    if (field === 'nom' || field === 'type') {
        renderProgram();
    } else if (field === 'allure') {
        const seance = programData.weeks[weekIdx][seanceIdx];
        if (!seance.customAllure) {
            seance.allureText = programData.allures[value];
            seance.allurePct = programData._allurePct[value];
        }
        renderProgram();
    }
}

function normalizeSeanceNames(weekIdx){
    const week = programData.weeks[weekIdx];
    if(!week) return;
    for(let k=0;k<week.length;k++){
        const s = week[k];
        if(/^Semaine \d+ - Séance \d+$/.test(s.nom)){
            s.nom = `Semaine ${weekIdx+1} - Séance ${k+1}`;
        }
    }
}

function deleteSeance(weekIdx, seanceIdx){
    if(confirm("Supprimer cette séance ?")){
        programData.weeks[weekIdx].splice(seanceIdx, 1);
        normalizeSeanceNames(weekIdx);
        renderProgram();
    }
}
function addSeance(weekIdx){
    programData.weeks[weekIdx].push({
        nom: `Semaine ${weekIdx+1} - Séance ${programData.weeks[weekIdx].length + 1}`,
        type: 'Endurance',
        echauffement: 15,
        corps: '40 min en endurance fondamentale',
        allure: 'ef',
        allureText: programData.allures.ef,
        allurePct: programData._allurePct.ef,
        cooldown: 10,
        customAllure: false
    });
    normalizeSeanceNames(weekIdx);
    renderProgram();
}

function generateHTMLInSameWindow(){
    fetch('/editor/generate', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(programData)
    })
    .then(r => r.text())
    .then(html => {
        document.open();
        document.write(html);
        document.close();
    })
    .catch(err => alert("Erreur génération: " + err));
}

function downloadHTML(){
    fetch('/editor/download', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(programData)
    })
    .then(r => r.blob())
    .then(blob => {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'programme_' + (programData.title||'RunGenius').replace(/\s+/g,'_') + '.html';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
    })
    .catch(err => alert("Erreur téléchargement: " + err));
}

function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;").replaceAll("<","&lt;")
    .replaceAll(">","&gt;").replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function escapeAttr(s){ return escapeHtml(s).replaceAll("\n"," "); }

document.getElementById('raceDate').value = new Date(Date.now() + 90*24*60*60*1000).toISOString().split('T')[0];
updatePaceCards();
</script>
</body>
</html>